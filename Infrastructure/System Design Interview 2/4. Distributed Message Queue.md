# Distributed Message Queue

- 이번 장에서는 시스템 디자인 면접에서 자주 등장하는 질문인 분산 message queue를 설계해보자. 현대 아키텍쳐에서 시스템은 작고 서로 독립된  
  컴포넌트들로 나눠지고, 이들은 잘 정의된 인터페이스를 두고 소통한다. Message queue는 이 컴포넌트들이 서로 상호작용하는 방법을 제공한다.  
  그렇다면 message queue가 어떤 이점을 가져다 줄까?

  - Decoupling: Message queue는 서로 다른 컴포넌트가 강결합되는 것을 막아 서로 독립적으로 개발될 수 있게 한다.
  - Improved scalability: 트래픽량에 따라 producer와 consumer 각각을 확장할 수 있다. 예를 들어 사용량이 많은 시간대에는 consumer만  
    확장해 늘어난 트래픽을 처리하도록 할 수 있다.
  - Increased availability: 시스템의 일부가 장애가 난다면, 다른 컴포넌트들은 queue를 사용해 계속해 상호작용할 수 있다.
  - Better performance: Message queue는 비동기 통신을 쉽게 하도록 한다. Producer들은 queue에 consumer가 메시지를 소비하기를 기다리지  
    않고, 단순히 메시지를 전달하고 다른 일을 할 수 있다. 즉 consumer, producer가 서로의 작업이 완료되기를 기다릴 필요가 없다.

- 다음은 유명한 분산 message queue들이다.
  - Apache Kafka, Apache RocketMQ, RabbitMQ, Apache Pulsar, Apache ActiveMQ, ZeroMQ

#### Message queues vs Event streaming platforms

- 위의 유명한 message queue들 중 따지고 보면 Apache Kafka와 Pulsar는 event streaming platform이지, message queue는 아니다.  
  하지만 message queue와 event streaming platform을 구분짓는 경계를 허무는 다양한 기능들을 제공한다. 예를 들어 일반적인 message queue인  
  RabbitMQ는 선택적으로 stream 기능을 사용할 수 있도록 한다. 이 stream 기능은 event streaming platform처럼 append-only log 방식으로  
  구현되어 있고, 메시지의 반복적인 소비와 메시지의 생명주기를 길게 다룰 수 있도록 해준다. 또한 Apache Plusar는 Kafka의 대조군인데,  
  일반 분산 message queue로 사용해도 될 정도로 유연하고 성능이 좋다.

- 이번 장에서는 long data retention, repeated consumption of messages 등 event streaming platform에서 제공할 만한 추가적인  
  기능을 가진 분산 message queue를 설계해볼 것이다. 이 기능들은 설계를 더욱 복잡하게 한다.

## 문제 이해 및 설계 범위 확정

- 기본적으로 message queue의 기능은 매우 간결하고 단순한데, producer는 메시지를 queue에 보낼 수 있어야 하고, consumer들은 이 메시지들을  
  가져와 사용(소비)할 수 있어야 한다. 이 기능 외에도 성능, 메시지 전달 방식, 메시지 retention 등의 고려 요소들이 많다.  
  이번에 디자인할 분산 message queue가 제공하는 기능 요구사항은 아래와 같다.

  - Producer들은 메시지를 message queue에 보낼 수 있다.
  - Consumer들은 message queue로부터 메시지를 소비한다.
  - 메시지는 한 번, 또는 여러 번 소비될 수 있다.
  - 메시지의 크기는 KB 단위이다.
  - Queue에 메시지가 전달된 순서대로 consumer에게 전달된다.
  - 데이터 전달 방식(at-least once, at-most once, exactly once)는 사용자들이 설정할 수 있다.

- 아래는 비 기능적 요구사항들이다.

  - Use case에 따라 높은 처리량 또는 낮은 latency를 제공해야 한다.
  - Scalability: 시스템은 분산 처리되어 있어야 한다. 따라서 전송되는 메시지가 갑자기 치솟아도 이를 감당할 수 있어야 한다.
  - Persist, durable: 데이터는 disk에 저장되어야 하고, 여러 개의 node들에 복제되어야 한다.

### 일반적인 message queue

- 위 요구사항들은 일반적인 message queue에서는 제공하지 않는 기능들을 포함한다. 예를 들어 일반적인 message queue는 메시지를 소비될 때까지  
  메모리에만 보관하고, 일반적으로 메시지의 순서를 보장하지 않는다. 이 기능이 없으면 설계가 훨씬 쉬워진다.

---
