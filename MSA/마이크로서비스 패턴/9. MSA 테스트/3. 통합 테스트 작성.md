# 통합 테스트 작성

- 서비스는 대부분 다른 서비스와 상호 작용한다. 아래 그림은 주문 서비스가 다른 서비스들과 소통하는 모습을 보여준다.

![picture 72](/images/MSAP_9_11.png)

- 주문 서비스의 REST API는 API gateway가 소비하고, 도메인 이벤트는 주문 이력 서비스 등 다른 서비스들이 소비한다.  
  주문 서비스 역시 다른 서비스들을 사용하는데, MySQL에 `Order` entity를 저장하고, 주방 서비스를 비롯한 다른 서비스들에게 command를  
  보내서 받은 응답을 소비한다.

- 서비스가 잘 동작하는지는 인프라 서비스, 타 애플리케이션 서비스와 적절히 상호작용 하는지 확인해봐야 알 수 있다. 서비스를 전부 띄워놓고 일일이  
  API를 호출해보는 e2e 테스트를 해보면 가장 확실하겠지만, 이러한 테스트는 느리고 취약하며 비용도 많이 든다. E2e 테스트도 나름의 역할은  
  있지만 test pyramid의 최상위에 위치한 만큼 가급적 개수는 줄이는 것이 좋다.

  ![picture 73](/images/MSAP_9_12.png)

- 따라서 단위 테스트 바로 위에 있는 통합 테스트를 작성하는 것이 훨씬 바람직한 전력이다.  
  통합 테스트는 e2e 테스트처럼 전체 서비스를 실행시키지 않는다. 그 대신 테스트 효과에 영향을 끼치지 않고도 테스트를 매우 간소화시키기 위해  
  아래의 2개 전략을 사용한다.

  - (1) 각 서비스의 adapter(가능하면 해당 adapter의 지원 클래스까지) 테스트한다. 예를 들어 주문 서비스 API를 호출해 테스트하는 것이  
    아니라 `OrderRepository` 클래스 자체를 직접 테스트하는 것이다. 이렇게 전체 서비스 대신 소수의 클래스로 테스트 범위를 좁히면 테스트가  
    상당히 단순, 신속해진다.

  - (2) 계약을 활용한다. _계약_ 은 두 서비스 간의 상호 작용의 구체적인 사례이다.  
    계약의 구조는 서비스 간 상호 작용의 종류마다 아래처럼 다르다.

    | 상호 작용 유형          |     consumer     |  provider   |             contract             |
    | :---------------------- | :--------------: | :---------: | :------------------------------: |
    | REST request/response   |   API Gateway    | 주문 서비스 |      http request/response       |
    | publish/subscribe       | 주문 이력 서비스 | 주문 서비스 |          도메인 이벤트           |
    | 비동기 request/response |   주문 서비스    | 주방 서비스 | command message/response message |

    - 계약은 publish/subscribe인 경우 메시지 1개, 요청/응답 및 비동기 요청/응답의 상호 작용인 경우에는 메시지 2개로 구성된다.
    - 계약의 용도는 consumer, provider를 둘 다 테스트해 서로 바라보는 API가 일치하는지 확인하기 위함이다.  
      사용 방법은 테스트 대상이 consumer인지 provider인지에 따라 다르다.

      - consumer: Consumer의 adapter에 대한 테스트. 계약을 이용해 provider를 mocking한 stub을 구성할 수 있기에 provider를  
        실행하지 않고 consumer 통합 테스트를 작성할 수 있다.
      - provider: Provider의 adapter에 대한 테스트. Adapter의 의존성들을 mock으로 잡아놓고 계약을 이용해 adapter를 테스트한다.

---
