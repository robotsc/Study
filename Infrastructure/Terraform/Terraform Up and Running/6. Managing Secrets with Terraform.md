# Managing Secrets with Terraform

- 데이터베이스 비밀번호, API Key, TLS 인증서 등 다양한 비밀 값이 포함되어 있는 상황이 발생할 수 있다.  
  예를 들어, 아래처럼 데이터베이스를 배포하기 위한 Terraform 코드가 있다고 해보자.

```tf
resource "aws_db_instance" "example" {
  identifier_prefix   = "terraform-up-and-running"
  engine              = "mysql"
  allocated_storage   = 10
  instance_class      = "db.t2.micro"
  skip_final_snapshot = true
  db_name             = var.db_name

  username = "???"
  password = "???"
}
```

- 위 코드는 username과 password, 2개의 비밀 값을 사용한다. 이러한 값들을 어떻게 안전하게 관리할까?

- 이 부분은 _secrets management_ 의 넓은 주제이며, 아래의 세 가지를 다룰 것이다.

  - Secret management basics
  - Secret management tools
  - Secret management tools with Terraform

## Secret management basics

- 가장 중요한 점은 **비밀 값을 plain text로 하드코딩하지 않는 것** 이다. 아래처럼 하지 말라는 것이다.

```tf
resource "aws_db_instance" "example" {
  identifier_prefix   = "terraform-up-and-running"
  engine              = "mysql"
  allocated_storage   = 10
  instance_class      = "db.t2.micro"
  skip_final_snapshot = true
  db_name             = var.db_name

  username = "admin"
  password = "password"
}
```

- Plain text로 비밀 값을 저장하는 것은 좋지 못한 생각이다. 아래는 그 이유 중 일부이다.

  - VCS에 접근 권한이 있는 누구나 비밀 값 또한 접근할 수 있다.
  - VCS에 접근 가능한 어떠한 컴퓨터도 비밀 값에 접근할 수 있다.
  - 실행되고 있는 소프트웨어들이 비밀 값에 접근할 수 있다.
  - 비밀 값의 접근 추적을 하거나 권한 회수가 불가능하다.

---

## Secret management tools

- Terraform과 함께 비밀 값들을 관리하기 위한 도구를 사용하려면 아래의 주제들을 알아두는 것이 좋다.

  - 저장할 수 있는 비밀 값들의 종류
  - 비밀 값들을 저장하는 방식
  - 비밀 값에 접근하기 위해 사용하는 인터페이스
  - Secret management tool들의 비교

### 저장할 수 있는 비밀 값들의 종류

- 비밀 값들은 크게 세 가지 종류로 분류된다.

  - Personal secrets: 개인에게 속하는 비밀 값으로, 웹사이트를 사용하기 위한 아이디와 비밀번호 등이 있다.
  - Customer secrets: 고객에게 속하는 비밀 값으로, 고객이 우리의 웹사이트에 접속하기 위해 사용하는 아이디와 비밀번호 등이 있다.
  - Infrastructure secrets: 인프라에 속하는 비밀 값으로, 데이터베이스 비밀번호 등이 있다.

- 대부분의 secret management tool들은 위 세가지 중 하나를 관리하기 위한 목적이 있으며, 그 목적에 부합하게 사용하는 것이 올바르다.

### 비밀 값들을 저장하는 방식

- 비밀 값들을 저장하는 방법은 크게 두 가지가 있는데, 하나는 file-based secret store이고, 다른 하나는 centralized secret store이다.

- _File-based secret store_ 는 비밀 값들을 암호화된 파일들에 저장하고, 이들은 일반적으로 VCS에서 검사가 이뤄진다.  
  파일을 암호화하기 위해서는 암호 key가 필요하며, 이 암호 key 자체 또한 비밀값이다. 그러다면 암호 key는 어떻게 관리할 것인가?

- 위의 문제에 대한 일반적인 해결책은 cloud provider가 제공하는 _KMS(Key Management Service)_ 를 사용하는 것이다.  
  이들은 모두 cloud provider를 신뢰해 cloud provider가 안전하게 비밀 값들을 관리하고, 접근 제어도 하도록 한다.  
  또다른 방법은 PGP Key(Pretty Good Privacy Key)를 사용하는 것인데, 이는 public key와 private key로 구성된다.

- _Centralized secret store_ 는 일반적으로 웹 서비스의 형태로 제공되며, 네트워크로 상호 작용하며 비밀 값들을 MySQL, PostgreSQL 등의  
  데이터베이스에 저장한다. 비밀 값들을 암호화하기 위해 centralized store들은 암호화 key를 필요로한다. 일반적으로 이 암호화 key는  
  서비스 자체에 의해 관리되거나, KMS를 사용하여 관리된다.

### 비밀 값에 접근하기 위해 사용하는 인터페이스

- 대부분의 secret management tool들은 API, CLI 혹은 다른 UI를 통해 접근할 수 있다.

- Centralized secret store들이 제공하는 이러한 API는 코드가 프로그래밍적으로 비밀 값들을 읽어와 사용할 때 유용하다.

- 모든 file-based secret store는 CLI를 기반으로 동작한다. CLI는 개발자들이 비밀 값에 접근하기 위한 편리한 수단이다.

- Centralized secret store 중 일부는 웹, 데스크톱 혹은 모바일 UI도 제공한다.

### Secret management tool들의 비교

- 아래 그림은 유명한 secret management tool들을 세 가지 유의 사항을 기반으로 비교한 것이다.

  ![picture 1](/images/TFRU_20.png)
  ![picture 2](/images/TFRU_21.png)

---
