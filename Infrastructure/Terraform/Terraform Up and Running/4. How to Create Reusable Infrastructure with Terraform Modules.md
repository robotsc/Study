# How to Create Reusable Infrastructure with Terraform Modules

- 이전 장에서 배포했던 환경을 아래 그림과 같이 staging, 그리고 production의 두 가지 환경에 동일하게 배포하고 싶다고 해보자.

  ![picture 1](/images/TFRU_16.png)

- production 환경에 staging과 동일한 환경을 코드의 복사, 붙여넣기 없이 어떻게 동일하게 구성할 수 있을까?

- Ruby와 같은 일반적인 프로그래밍 언어의 경우, 동일한 코드를 다른 곳으로 복사 붙여넣기 하는 대신 해당 부분을 함수로 빼내어  
  함수 호출로 동일한 코드를 재사용할 수 있다.

  ```rb
  def example_function()
    puts "Hello, World"
  end
  ```

- 반면 Terraform의 경우, 반복해 사용할 코드를 _Terraform module_ 내에 넣어놓고, 여러 곳에서 해당 모듈을 불러와 사용하는 것으로  
  코드의 재사용을 가능하게 한다. 아래 그림과 같다.

  ![picture 2](/images/TFRU_17.png)

- 이 기능은 꽤나 획기적이다. 모듈은 재사용성이 좋고, 유지보수하기 쉬우며, 테스트하기 쉬운 Terraform 코드를 작성하기 위한 핵심 요소이다.  
  한 번 쓰기 시작하면 다시 돌아가지 못할 것이다. 실제로 모든 것을 모듈로 만들어나갈 수 있다.

## Module Basics

- Terraform module은 매우 단순한데, 특정 폴더 하위에 있는 Terraform configuration file들의 집합은 모두 module이다.  
  지금까지 작성했던 Terraform code들은 모두 모듈이다. 그리고 `terraform apply`를 할 때 각 폴더에 들어가서 실행했는데,  
  이런 모듈을 _root module_ 이라고 부른다. 모듈이 어떤 효과를 제공하는지 느끼려면 재사용성 가능한 모듈을 만들어봐야 한다.

- 아래 그림처럼 기존에 `stage/services/webserver-cluster` 하위에 있던 모든 파일들을 `modules/services/webserver-cluster`의  
  하위로 이동시켜보자.

  ![picture 3](/images/TFRU_18.png)

- 이제 위에서 생성한 module을 staging 환경에서 사용할 수 있다.  
  모듈을 사용하는 문법은 아래와 같다.

  ```tf
  module "<NAME>" {
    source = "<SOURCE>"
    [CONFIG...]
  }
  ```

  - `<NAME>`: Terraform code에서 해당 모듈을 사용하기 위한 모듈 이름
  - `<SOURCE>`: 모듈 코드가 있는 경로

- 먼저 `stage/services/webserver-cluster` 하위에 아래의 내용을 담은 `main.tf` 파일을 생성해보자.

```tf
provider "aws" {
  region = "us-east-2"
}

module "webserver_cluster" {
  source = "../../../modules/services/webserver-cluster"
}
```

- 이처럼 `prod` 폴더를 상위에 만들고, `prod/services/webserver-cluster` 하위에 `main.tf` 파일을 생성하고,  
  아래와 같이 작성해보자.

```tf
provider "aws" {
  region = "us-east-2"
}

module "webserver_cluster" {
  source = "../../../modules/services/webserver-cluster"
}
```

- 이제 `prod/services/webserver-cluster` 폴더에서 `terraform init`을 수행하면 module 초기화 단계가 추가된 것을 확인할 수 있다.

- 여기서 `terraform apply`를 수행하기 전, 한 가지 문제점이 있다. 바로 `webserver-cluster` module의 모든 값들이  
  하드코딩되어 있다는 것이다. 예를 들어 security group, ALB name 등 말이다. 그렇기에 이 모듈을 동일한 AWS 계정 내에서  
  두 번 이상 사용하면 충돌이 발생할 것이다.

- 위 문제를 해결하기 위해 `webserver-cluster` module이 설정 가능한 input을 받을 수 있도록 수정해보자.

---

## Module Inputs

- Terraform module은 input parameter를 가질 수 있다. 이를 정의하려면 _input variable_ 을 선언하는 것과 동일하게 하면 된다.  
  `modules/services/webserver-cluster/variables.tf` 파일을 아래처럼 작성해보자.

```tf
variable "cluster_name" {
  description = "The name to use for all the cluster resources"
  type        = string
}

variable "db_remote_state_bucket" {
  description = "The name of the S3 bucket for the database's remote state"
  type        = string
}

variable "db_remote_state_key" {
  description = "The path for the database's remote state in S3"
  type        = string
}
```

- 다음으로 기존에 있던 `modules/services/webserver-cluster/main.tf`가 하드코딩된 값이 아닌 variable을 사용하도록 수정해보자.  
  아래는 `aws_lb` 리소스만 수정했지만, 이름이 필요한 모든 리소스에 동일하게 적용해주자.

```tf
#..

resource "aws_lb" "example" {
  name               = "${var.cluster_name}-alb"
  load_balancer_type = "application"
  subnets            = data.aws_subnets.default.ids
  security_groups    = [aws_security_group.alb.id]
}

#..

data "terraform_remote_state" "db" {
  backend = "s3"
  config = {
    bucket = var.db_remote_state_bucket
    key    = var.db_remote_state_key
    region = "us-east-2"
  }
}
```

- 이제 `stage/services/webserver_cluster/main.tf`와 `prod/services/webserver_cluster/main.tf`에서  
  모듈 선언부 내에 input variable들을 각각 지정해주자.

```tf
# stage/services/webserver_cluster/main.tf
provider "aws" {
  region = "us-east-2"
}

module "webserver_cluster" {
  source = "../../../modules/services/webserver-cluster"

  cluster_name           = "webservers-stage"
  db_remote_state_bucket = "terraform-up-and-running-state-roy-ra"
  db_remote_state_key    = "stage/data-stores/mysql/terraform.tfstate"
}

# prod/services/webserver_cluster/main.tf

provider "aws" {
  region = "us-east-2"
}

module "webserver_cluster" {
  source = "../../../modules/services/webserver-cluster"

  cluster_name           = "webservers-prod"
  db_remote_state_bucket = "terraform-up-and-running-state-roy-ra"
  db_remote_state_key    = "prod/data-stores/mysql/terraform.tfstate"
}
```

- 위에서 볼 수 있듯이 module에 input variable을 지정하는 것은 resource에 인자를 지정하는 것과 동일한 문법을 사용한다.

- 여기까지 해서 이름과 database remote state을 위한 input variable을 지정해보았는데, module의 다른 파라미터들도  
  직접 설정할 수 있게끔 해보자. 예를 들어, staging 환경에는 prod보다 더 적은 수의 서버를 띄우고 싶을 수 있다.  
  이를 위해 3개의 input variable을 더 추가해보자.

```tf
# modules/services/webserver-cluster/variables.tf

#..
variable "instance_type" {
  description = "The type of EC2 instances to run(e.g. t2.micro)"
  type        = string
}

variable "min_size" {
  description = "The minimum number of EC2 instances in the ASG"
  type        = number
}

variable "max_size" {
  description = "The maximum number of EC2 instances in the ASG"
  type        = number
}
```

- 다음으로 `modules/services/webserver-cluster/main.tf`의 launch configuration과 ASG 리소스를 수정해보자.

```
resource "aws_launch_configuration" "example" {
  image_id        = "ami-0fb653ca2d3203ac1"
  instance_type   = var.instance_type
  security_groups = [aws_security_group.instance.id]

  user_data = templatefile("user-data.sh", {
    server_port = var.server_port
    db_address  = data.terraform_remote_state.db.outputs.address
    db_port     = data.terraform_remote_state.db.outputs.port
  })

  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_autoscaling_group" "example" {
  launch_configuration = aws_launch_configuration.example.name

  min_size = var.min_size
  max_size = var.max_size

  vpc_zone_identifier = data.aws_subnets.default.ids

  target_group_arns = [aws_lb_target_group.asg.arn]
  health_check_type = "ELB"

  tag {
    key                 = "Name"
    value               = var.cluster_name
    propagate_at_launch = true
  }
}
```

- 마지막으로 stage, prod 하위의 module 정의부 각각에 input variable을 지정해주자.

```tf
# stage/services/webserver_cluster/main.tf
provider "aws" {
  region = "us-east-2"
}

module "webserver_cluster" {
  source = "../../../modules/services/webserver-cluster"

  cluster_name           = "webservers-stage"
  db_remote_state_bucket = "terraform-up-and-running-state-roy-ra"
  db_remote_state_key    = "stage/data-stores/mysql/terraform.tfstate"

  instance_type = "t2.micro"
  min_size      = 2
  max_size      = 2
}


# prod/services/webserver_cluster/main.tf
provider "aws" {
  region = "us-east-2"
}

module "webserver_cluster" {
  source = "../../../modules/services/webserver-cluster"

  cluster_name           = "webservers-prod"
  db_remote_state_bucket = "terraform-up-and-running-state-roy-ra"
  db_remote_state_key    = "prod/data-stores/mysql/terraform.tfstate"

  instance_type = "t3.medium"
  min_size      = 2
  max_size      = 10
}

```
