# Ad Click Event Aggregation

- Facebook, YouTube, TickTock 등 온라인 미디어 생태계가 활성화되면서 이러한 플랫폼에 사용되는 광고 비용이 거의 매일 최고치를 찍고  
  있다. 따라서 특정 광고의 클릭 이벤트 등을 추적하는 일이 매우 중요해졌다. 이번 장에서는 Facebook, Google의 규모에서 사용되는 광고 클릭  
  이벤트를 취합하는 시스템을 설계해보자.

- 기술적 설계에 들어가기 전에 이 주제를 조금 더 잘 이해하기 위해 우선 온라인 광고에 대해 살펴보자.  
  온라인 광고의 가장 큰 이점 중 하나는 실시간성 데이터로 관측이 가능하다는 것이다.

- 디지털 광고는 RTB(Real-Time Bidding)이라는 핵심 프로세스가 있으며, 이 프로세스는 디지털 광고가 사고 팔리는 것을 의미한다.  
  아래 그림은 온라인 광고의 프로세스를 나타낸다.

  ![picture 1](/images/SDI2_ACEA_1.png)

- RTB는 주로 1초 내로 완료되기 때문에 RTB의 속도는 매우 중요하다.

- 데이터의 정확도 또한 중요하다. 광고 클릭 이벤트 취합은 온라인 광고의 효율성을 나타내는 핵심 지표로 활용되고, 이 지표에 따라 광고주들이 지불하는 금액이  
  달라지기 때문이다. 광고 클릭 이벤트의 취합 결과에 따라 광고 캠패인 관리자는 광고 대상이나 키워드 및 예산이나 bidding 전략을 조정한다. 온라인 광고에서  
  사용되는 핵심 metric들인 CTR(click-through rate), CVR(conversion rate)는 모두 취합된 광고 클릭 데이터에 의존한다.

## 문제 이해 및 설계 범위 확정

- 아래는 기본적인 요구사항이다.

  - Input data는 여러 개의 서로 다른 서버에 위치한 log file이며, 최신 클릭 이벤트들은 log file의 마지막에 append된다.  
    그리고 이벤트는 `ad_id`, `click_timestamp`, `user_id`, `ip`, `country`의 속성을 갖는다.
  - 매일 10억 번의 광고 클릭이 발생하며, 총 200만개의 광고가 있다.  
    광고 클릭은 매년 30%씩 증가한다.
  - 가장 핵심적으로 지원해야 하는 query는 아래와 같다.
    - 특정 광고의 최근 _M_ 분 내의 클릭 이벤트 회수 조회
    - 최근 _M_ 분 동안 가장 많이 클릭된 광고 _N_ 개 조회
    - 위의 두 query에 대해 데이터가 `ip`, `user_id`, `country`로 필터링될 수 있어야 한다.
  - 예상보다 늦게 도착하는(late-arriving) 이벤트에 대한 처리
  - 중복 이벤트에 대한 처리
  - 시스템의 다양한 컴포넌트에 문제가 생겨 down time이 발생하는 경우에 대한 처리
  - RTB Latency는 1초 미만이어야 한다.
  - 광고 클릭 이벤트의 취합 과정 latency는 수 분 내로 이뤄져야 한다.

- 이번에 설계할 시스템의 요구사항은 아래와 같다.

  - 특정 `ad_id`를 가진 광고에 대해 최근 _M_ 분 동안 발생한 클릭 횟수 취합
  - 최근 _M_ 분 동안 가장 많이 클릭된 _N_ 개의 광고 취합
  - 다양한 속성들로 취합된 결과에 대한 필터링 지원
  - 데이터의 volume은 Facebook 또는 Google의 규모이다.

- 추가적으로 아래의 요구 사항들이 있다.

  - 취합된 데이터가 billing, RTB에 사요되므로 데이터의 정확도가 매우 중요하다.
  - 지연되거나 중복된 이벤트를 적절히 처리해야 한다.
  - 시스템은 부분 장애를 감내할 수 있어야 한다.
  - End-to-end latency는 수 분 내여야 한다.

- 이제 위의 요구사항들에 기반해 필요한 정보들을 수치화해보자.

  - DAU: 10억 명
  - 평균적으로 한 사용자가 광고를 1회 클릭한다 가정했을 때, 매일 10억 건의 광고 클릭 이벤트가 발생한다.
  - Ad click QPS = `10^9 events / 10^5 seconds in a day = 10000`
  - Peak ad click QPS가 평균치의 5배라 가정했을 때 Peak QPS = 50000
  - 한 건의 클릭 이벤트가 0.1KB의 저장 공간을 차지한다고 가정했을 때 매일 소모되는 저장 공간은 `0.1KB * 10억 = 100GB`이다.  
    그리고 매달 필요한 저장 공간은 `100GB * 30 = 3TB`이다.

---
