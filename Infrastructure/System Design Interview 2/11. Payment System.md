# Payment System

- 이번 장에서는 결제 시스템을 설계해보자. 최근 수년 동안 e-commerce 시장은 급성장했고, 각 결제 transaction을 가능하게끔  
  하는 것은 뒷단에서 동작하는 겾제 시스템이다. 따라서 안정적이고 확장성 있고 유연한 결제 시스템은 사실상 필수 요소이다.

- 결제 시스템이 무슨 일을 하는지는 명확하지만 제대로 개발 및 유지하려면 많은 개발자들의 뇨력이 필요하다. 작은 실수가 있다면  
  수익에 직결되고, 사용자들로부터의 신뢰를 잃기도 가장 쉬운 부분이기도하다.

## 문제 이해 및 설계 범위 확정

- 결제 시스템은 굉장히 다양한 것을 의미할 수 있다. 누군가에게는 Apple Pay, Samsung Pay 등의 전자 지갑의 의미를 가질 수 있고,  
  누군가는 PayPal, Stripe 처럼 뒷단에서 결제를 처리하는 시스템으로 알고 있을 수 있다. 따라서 이번에도 여느 때와 마찬가지로  
  설계에 들어가기 전, 먼저 요구사항을 확실히 해보도록 하자.

### 기능적 요구사항

- Amazon.com과 같은 e-commerce 애플리케이션의 결제 백엔드를 담당한다고 생각하면 된다. 사용자가 주문을 시작하는 순간,  
  우리가 설계하는 시스템이 돈과 관련된 모든 부분을 처리한다.

- 신용카드, PayPal 등 실세계에서 사용되는 모든 결제 수단을 지원해야 한다.

- Strip, Braintree 등 제3자 결제 플랫폼을 사용하기 때문에 결제 과정에 대해서는 신경쓰지 않아도 된다.

- 신용카드 정보 등 매우 민감한 정보들은 제3자 서비스를 사용해 저장 및 관리한다.

- 애플리케이션 자체는 global service이지만, 환율은 하나만 사용한다고 가정한다.

- 매일 백만 건의 결제가 이뤄진다.

- 결제 시스템은 accounting, analytics 등 다양한 internal service들 및 payment service provider 등 다양한 external  
  service와 모두 상호작용한다. 따라서 서비스에 장애가 나면, 다른 서비스들과 상태가 일치하지 않는 상황이 발생할 수 있다.  
  따라서 이러한 불일치를 해결하기 위한 과정이 필요하다.

- 위 내용들을 모두 요약하면 아래 2개로 정리할 수 있다.

  - Pay-in flow: 결제 시스템은 판매자들을 대신해 고객으로부터 돈을 받는다.
  - Pay-out flow: 결제 시스템은 전세계의 판매자들에게 돈을 보낸다.

### 비 기능적 요구사항

- 안정성 및 장애 감래: 실패한 결제 내역들은 잘 관리되어야 한다.
- Internal service(accounting, payment system)들과 external service(payment service provider)들 사이의  
  상태 불일치를 해결하기 위한 과정이 필요하다. 이 프로세스는 특정 결제에 대한 정보가 전체 시스템에 걸쳐 일관성이 있는지를 비동기적으로 확인한다.

### 개략적 수치 추정

- 이 시스템은 하루에 100만건의 결제가 이뤄진다. 즉 TPS는 `1000000 / 10^5 = 10`이다.  
  일반적인 데이터베이스에서 10 TPS는 전혀 큰 수치가 아니기 때문에 이번 설계는 높은 처리량을 감당하는 부분이 아닌 어떻게 결제 과정을  
  안정적으로 처리할지에 대해 더 중점을 둘 것이다.

---
