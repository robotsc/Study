# 관측 가능한 서비스 설계

- 서비스를 production에 배포하면 초당 요청 수, 리소스 이용률 등 현재 애플리케이션의 상태를 추적해야 한다.  
  서비스 인스턴스가 실패하거나 디스크가 다 차버리는 등의 문제가 생기면 사용자에게 영향을 끼치기 전에 그 사실을  
  알아내고 대응해야 하기 때문이다.

- 하드웨어의 가용성, 이용률을 모니터링하는 등 애플리케이션을 운영하는 일은 대부분 운영자의 몫이지만, 개발자가 서비스 인스턴스의  
  동작과 health가 표출되도록 개발하면 운영자가 좀 더 쉽게 관리하고 troubleshooting할 수 있을 것이다.

- 아래는 이러한 관측 가능한 서비스를 설계하는 패턴이다.

  - **Health check API** : 서비스의 health를 반환하는 endpoint를 표출한다.
  - **Log aggregation** : 서비스 활동을 logging하면서 검색/경고 기능이 구현된 중앙 로그 서버에 로그를 출력한다.
  - **Distributed tracing** : 각 외부 요청에 ID를 하나씩 부여해 서비스 사이를 드나드는 과정을 추적한다.
  - **Exception tracking** : 예외 중복 제거, 개발자 알림, 예외별 해결 상황 추적 등을 수행하는 예외 추적 서비스에 예외를 보고한다.
  - **Application metrics** : 카운터, 게이지 등의 지표를 유지하고 수집한 데이터를 지표 서버에 표출한다.
  - **Audit logging** : 사용자 액션을 logging한다.

  ![picture 110](/images/MSAP_PRDS_10.png)

- 이런 패턴들의 가장 두드러진 특징은 개발자, 운영자 각자의 업무 영역이 각각 정해져 있다는 것이다.  
  가령 health check API 패턴에서 개발자는 본인이 개발한 서비스의 health check endpoint를 정확히 구현하고, 운영자는  
  health check API를 주기적으로 호출해 시스템을 모니터링한다. Log aggregation도 개발자는 서비스가 유용한 로그를 남기도록  
  개발하고, 운영자는 로그를 수집한다.

## Health check API 패턴

- 실행 중이지만 요청을 처리할 수 없는 서비스가 있다. 예를 들어 이제 막 시작한 서비스 인스턴스도 준비가 다 끝날 때까지 요청을 받아  
  처리할 수 없다. 요청을 처리할 준비가 덜 된 상황에서 배포 인프라가 서비스 인스턴스에 HTTP 요청을 routing해봐야 무의미할 것이다.

- 또한 서비스 인스턴스가 중단되지 않고 실패할 수도 있다. 예를 들어 DB connection이 고갈되어 DB에 접근할 수 없을 수 있다.  
  실행 중이지만 실패한 서비스 인스턴스에는 요청을 보내면 안된다. 서비스 인스턴스가 복원되지 않으면 강제로 종료시킨 후 새로운  
  인스턴스를 생성해야 한다.

> Health check API: 서비스가 자신의 상태를 반환하는 `GET /health` 등의 health check API endpoint를 표출한다.

- 서비스 인스턴스는 자신이 요청을 처리할 수 있는 상태인지의 여부를 배포 인프라에 알려야 한다. 배포 인프라가 호출할 수 있는 health check  
  endpoint를 서비스에 구현하는 것이 좋은 방법이다. 배포 인프라는 서비스 인스턴스의 health 상태를 계속해 살피고, 문제가 있으면 즉시 조치를  
  할 수 있도록 주기적으로 health check endpoint를 호출한다.

  ![picture 111](/images/MSAP_PRDS_11.png)

- Health check 요청 핸들러는 서비스 인스턴스 및 외부 서비스의 접속 상태를 확인한다. DB에도 주기적으로 test query를 전송한다.  
  이 핸들러는 비어있는 HTTP respons에 적절한 status code를 반환할 때도 있지만, 각 adapter의 자세한 health 정보도 반환한다.  
  이 정보는 troubleshooting할 때 도움이 된다. 그러나 민감한 정보도 포함될 수 있기에 구현에 주의가 필요하다.

- Health check 기능을 구현할 때에는 서비스 인스턴스의 health를 보고하는 endpoint를 어떻게 구현할지, 배포 인프라는 helath check  
  endpoint를 어떻게 호출할지의 2개를 고려해야 한다.

### Health check endpoint 구현

- Health check endpoint를 구현한 코드는 서비스 인스턴스의 상태를 어떻게든 판단해야 한다. 일단 서비스 인스턴스가 외부 인프라 서비스에  
  접근 가능한지 확인하면 될 것이다. 물론 방법은 인프라 서비스마다 다르다. 예를 들어 RDBMS의 접속 상태는 DB connection을 획득하고  
  test query를 실행하면 알 수 있다. 클라이언트의 서비스 API 호출을 mocking한 가짜 transaction을 실행하면 더 정교하고 철저하게  
  health check를 할 수 있지만, 이는 구현하는 데 시간이 걸리고 노력도 많이 든다.

### Health check endpoint 호출

- Health check endpoint를 호출하는 코드가 없으면 health check endpoint 자체가 무의미하기 때문에 서비스를 배포할 때 배포  
  인프라가 이를 호출하게 해야 한다. 방법은 세부 인프라 구조마다 다르다. 예를 들어 Netflix Eureka 같은 service registry가  
  health check endpoint를 호출하도록 구성해 네트워크 트래픽이 서비스 인스턴스로 전송되었는지 확인할 수 있다.

---
