# Working with Multiple Providers

- 지금까지 이 코드의 예제들은 단 하나의 `provider` block만을 가지고 있었다.

```tf
provider "aws" {
  region = "us-east-2"
}
```

- 위의 `provider` block은 하나의 AWS 계정으로 하나의 region에 대해서만 사용이 가능하다. 이에 대해 아래의 의문점을 가질 수 있다.

  - 여러 개의 region에 배포하려면 어떻게 해야할까?
  - 여러 개의 AWS 계정을 사용해 배포하려면 어떻게 해야할까?
  - Azure, GCP 등의 다른 cloud provider들도 사용해야 하면 어떻게 해야할까?

- 위의 질문들에 대한 답을 알아보기 위해, Terraform provider와 관련해 아래의 내용을 다뤄보자.

  - Working with one provider
  - Working with multiple copies of the same provider
  - Working with multiple different providers

## Working with one provider

- 지금까지 사용한 대로 `provider` block을 사용하면 하나의 기본적인 provider를 사용해 간단한 예제들을 수행할 수 있다.  
  하지만 하나 이상의 region, account, cloud 등을 사용하려면 더 복잡한 구성이 필요하다.

- 우선 단일 provider를 사용하는 경우에 대해 살펴보자.

### What is a provider?

- 이 책의 2장에서는 provider를 Terraform이 상호작용하는 _platform_ 이라고 표현했으며, 여기에는 AWS, Azure, Googe Cloud 등이  
  있다고 했다. 그래서 Terraform이 이 플랫폼들과 어떻게 상호작용 하는 것일까?

- 내부적으로 Terraform은 두 가지 부분으로 구성된다.

  - **Core** : Core는 `terraform` 바이너리로, CLI, parser, HCL interpreter 등 모든 플랫폼이 사용하는 Terraform의  
    기본적인 기능들을 담고 있다. Go로 작성되어 있으며, 오픈소스로 공개되어 있다.

  - **Providers** : Terraform provider는 Terraform core를 위한 _plugin_ 이다. 각 플러그인은 특정 인터페이스를  
    구현하기 위해 Go로 작성되어 있으며, Terraform core는 플러그인을 설치하고 실행시키는 방법을 알고 있다.

    ![picture 1](/images/TFRU_22.png)

    - 각 provider는 특정한 prefix를 가지며, 하나 이상의 리소스와 data source를 노출한다. 예를 들어, AWS provider는  
      `aws_` prefix를 가지며, Azure의 경우에는 `azurerm_` prefix를 가지고 있다.

### How do you install providers?

- AWS, Azure, GCP 등의 공식 Terraform provider의 경우, `provider` block을 코드에 추가하는 것으로 충분하다.

```tf
provider "aws" {
  region = "us-east-2"
}
```

- 이 상태에서 `terraform init`을 수행하는 순간, Terraform은 해당 provider를 위한 코드를 다운로드하기 시작한다.  
  여기서 Terraform이 어떤 provider가 필요한지, 어떤 버전이 필요한지, 어디서로부터 다운로드해야 할지 등에 대한 세부 사항을  
  모두 파악할 필요는 없다. 하지만 상용 환경의 경우, Terraform이 provider를 설치하는 과정을 조작해야 하는 경우가 있는데,  
  이는 `required_providers` block을 통해 지정할 수 있다.

```tf
terraform {
  required_providers {
    <LOCAL_NAME> = {
      source = "<URL>"
      version = "<VERSION>"
    }
  }
}
```

- `LOCAL_NAME`: 모듈 내에서 provider를 사용할 _local name_ 이다. 각 provider에는 고유한 이름을 지정해줘야 하며,  
  이 이름을 가지고 `provider` block에서 사용할 수 있다. 대부분의 경우, 해당 provider의 _preferred local name_ 을  
  사용하는 것이 좋은데, 예를 들어 AWS의 경우에는 `aws`를 사용하면 된다.

- `URL`: `URL`은 Terraform이 provider를 사용하기 위한 코드를 다운받을 주소를 의미한다.  
  `[<HOSTNAME>/]<NAMESPACE>/<TYPE>`의 형식을 가지며 `HOSTNAME`은 provider를 배포하는 Terraform Registry의  
  hostname, `NAMESPACE`는 organizational namespace, 그리고 `TYPE`는 해당 provider가 관리하는 플랫폼을 말한다.  
  예를 들어 AWS provider의 전체 URL은 `registry.terraform.io/hashicorp/aws`이다.  
  여기서 `HOSTNAME`은 optional한 값으로, 만약 지정하지 않는다면 기본적으로 public Terraform Registry 주소가 들어가게 된다.

- `VERSION`: 버전에 대한 규악으로, 특정 버전으로 지정하거나, `> 4.0`, `< 4.3`과 같이 범위를 지정할 수도 있다.

```tf
terraform {
  required_providers {
    aws = {
      source = "hashicorp/aws"
      version = "~> 4.0"
    }
  }
}
```

- 만약 `foo`라는 `provider` block을 코드에 작성하고 `apply`를 수행하면, Terraform은 아래의 작업들을 자동으로 수행한다.

  - `foo`라는 이름을 가진 provider를 `HOSTNAME`이 public Terraform registry라고 가정하고 찾아 다운로드하려 한다.  
    그리고 이 URL이 유효하다면 가장 최신 버전을 다운받는다.

- 만약 `hashicorp` namespace가 아닌 Datadog, Cloudflare 등의 provider를 사용하고 싶거나 provider의 버전을 지정해 사용하고  
  싶다면 이 내용을 `required_providers` block에 지정해야 한다.

> 이후에 보겠지만, `required_providers` block을 항상 사용하는 것이 좋다.

### How to use providers?

- 이제 기존 코드를 아래처럼 바꿔보자.

```tf
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 4.0"
    }
  }
}

provider "aws" {
  region = "us-east-2"
}
```

- 지금까진 위에서 `provider` block에 region 설정만 해주었는데, 각 provider마다 다양한 설정 가능한 값들이 있다.  
  따라서 항상 해당 provider의 문서를 잘 찾아보도록 하자.

---
