# Distributed Email Service

- 이번 장에서는 Gmail, Outlook, Yahoo Mail과 같이 대형 규모의 이메일 서비스를 설계해보자.  
  인터넷 자체가 성장해가면서 이메일 서비스의 수요도 나날이 증가하고 있다. 2020년 Gmail은 활성 사용자 수가 18억명에 달했고,  
  Outlook은 전 세계에서 400만명에 달한다.

## 문제 이해 및 설계 범위 확정

- 최근 몇년간 이메일 서비스들은 점점 더 복잡해져왔고, 규모도 커져갔다. 현대 이메일 서비스는 많은 기능들은 가진 굉장히 복잡한 시스템이다.  
  따라서 설계를 하기 전 먼저 집중적으로 볼 기능들 및 요구사항들을 파악해보자.

### 기능적 요구사항

- 사용자 수: 10억명
- 이메일 전송 및 수신
- 모든 이메일 조회
- 읽음, 읽지 않음의 상태에 따른 이메일 필터링
- 주제, 발신자, 내용으로 이메일 검색
- Anti-spam, Anti-virus
- 클라이언트와 서버 사이의 소통으로는 HTTP가 사용된다.
- 이메일은 첨부 파일이 있을 수 있다.

### 비 기능적 요구사항

- Reliability: 이메일 데이터가 누락되면 안된다.
- Availability: 이메일과 사용자 데이터는 가용성을 보장하기 위해 여러 개의 node들로 자동으로 복제되어야 한다. 또한 시스템은 부분 장애가 있더라도  
  계속해서 동작할 수 있어야 한다.
- Scalability: 사용자 수가 증가하고 이메일의 수가 증가해도 시스템은 이를 잘 처리할 수 있어야 한다. 그리고 사용자 수, 이메일 수가 많아짐에 따라  
  시스템의 성능이 낮아지면 안된다.
- Flexibility, extensibility: 유연하고 확장성이 뛰어난 시스템은 새로운 컴포넌트들을 추가해 새로운 기능을 추가하거나 성능을 향상시키는 등의  
  작업을 쉽게 할 수 있게 한다. POP, IMAP 등 전통적인 이메일 프로토콜들은 굉장히 제한된 기능들만 제공한다. 따라서 유연성과 확장성을 보장하기 위해  
  이러한 이메일 프로토콜 외에 직접 프로토콜을 정의해 사용해야 할 수도 있을 것이다.

### 각종 추정치 계산

- 다양한 추정치들을 계산해 규모를 파악하고, 이를 설계하면서 발생할 수 있는 문제점들을 미리 파악해보자.

  - 10억명의 사용자
  - 한 사람이 하루에 발신하는 이메일이 10개라고 가정하면, 이메일을 전송하는 QPS는 `10^9 * 10 / 10^5 = 100,000`이다.
  - 한 사람이 하루에 수신하는 이메일이 40개라 가정하고, 이메일 metadata의 평균 크기가 50KB라고 가정하자.  
    Metadata는 첨부 파일을 제외한 이메일에 관련된 모든 나머지 정보들을 말한다.
  - Metadata가 저장소에 저장된다 해보자. 1년의 metadata를 유지하기 위해 필요한 저장 공간은 아래와 같다.  
    `10억명의 사용자 * 매일 40개 이메일 * 365일 * 50KB = 730PB`
  - 전체 이메일 중 20%가 첨부파일이 있으며, 첨부파일들의 평균 크기는 500KB라고 가정하자.
  - 1년의 첨부 파일들을 유지하기 위해 필요한 저장 공간은 아래와 같다.
    `10억명의 사용자 * 매일 40개의 이메일 * 365일 * 20% * 500KB = 1,460PB`

- 위 추정치들을 통해 이 시스템에서 굉장히 많은 양의 데이터를 다뤄야함은 분명한 사실이 되었다. 따라서 분산 데이터베이스를 사용하는 것이 좋을 것 같다.

---
