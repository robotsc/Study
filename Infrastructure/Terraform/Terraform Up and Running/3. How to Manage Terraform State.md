# How to Manage Terraform State

- `terraform apply` 또는 `terraform plan`을 수행할 때마다 Terraform은 자동으로 이전에 자신이 생성한 리소스를  
  확인하고, 해당 내용에 바탕으로 갱신 사항들을 만들어 보여줬다. 어떻게 이를 알 수 있을까? AWS에 직접 콘솔로, Terraform으로,  
  혹은 CLI 등의 다양한 방법으로 생성한 리소스들이 있을 것인데, Terraform은 어떻게 자신이 책임져야 하는 리소스를 구분지을 수 있을까?

- 이번 장에서는 Terraform이 인프라의 상태를 어떻게 관리하는지 파악해볼 것이다.

## What is Terraform state?

- Terraform을 실행할 때마다 Terraform은 생성된 인프라에 대한 정보를 _Terraform state file_ 에 저장한다.  
  만약 Terraform을 `/foo/bar` 폴더에서 실행한다면, Terraform은 `/foo/bar/terraform.tfstate` 파일을 생성한다.  
  이 파일은 JSON 형식으로, configuration file 내의 Terraform 리소스들과 실제로 배포된 리소스의 매핑 관계를 나타낸다.

- `terraform plan` 명령의 결과는 컴퓨터에 있는 state와 실제 클라우드 리소스의 state 사이의 diff 이다.

> State file은 Terraform 내부에서 사용되기 위한 private API 형식으로, 절대로 직접 해당 파일의 내용을 수정해서는 안된다.  
> 물론 이 상태 파일을 수정해야 할 경우도 있을 것이다. 주로 `terraform import` 또는 `terraform state` 명령을 사용할 때이다.

- Terraform을 개인적인 프로젝트에서 사용할 때 모든 상태를 로컬 컴퓨터에 하나의 `terraform.tfstate` 파일에 저장해도 무방하다.  
  하지만 만약 실제 프로덕트에 대해 Terraform을 팀 단위로 활용할 때 이렇게 진행하면 아래의 문제점들을 만날 수 있다.

  - Shared storage for state files: 팀원 각각이 동일한 Terraform state file을 사용할 수 있어야 한다.  
    즉, 로컬 컴퓨터에 저장해서는 안되고 공유 스토리지에 저장해야 한다.

  - Locking state files: 데이터가 공유되는 순간, locking 문제에 직면하게 된다. Locking이 없다면 팀원 두 명이  
    동일한 시점에 Terraform을 실행할 경우 Terraform이 동시적으로 리소스를 갱신하려는 등의 상황이 발생하면서  
    race condition이 발생할 수 있다.

  - Isolating state files: 인프라에 변경 사항을 적용할 때, 좋은 방법은 환경을 격리하는 것이다.  
    예를 들어, 개발 환경에 변경 사항을 만들 때 상용 환경에는 전혀 영향이 없을 것임을 보장해야 한다.

---
