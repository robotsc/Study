# How to Create Reusable Infrastructure with Terraform Modules

- 이전 장에서 배포했던 환경을 아래 그림과 같이 staging, 그리고 production의 두 가지 환경에 동일하게 배포하고 싶다고 해보자.

  ![picture 1](/images/TFRU_16.png)

- production 환경에 staging과 동일한 환경을 코드의 복사, 붙여넣기 없이 어떻게 동일하게 구성할 수 있을까?

- Ruby와 같은 일반적인 프로그래밍 언어의 경우, 동일한 코드를 다른 곳으로 복사 붙여넣기 하는 대신 해당 부분을 함수로 빼내어  
  함수 호출로 동일한 코드를 재사용할 수 있다.

  ```rb
  def example_function()
    puts "Hello, World"
  end
  ```

- 반면 Terraform의 경우, 반복해 사용할 코드를 _Terraform module_ 내에 넣어놓고, 여러 곳에서 해당 모듈을 불러와 사용하는 것으로  
  코드의 재사용을 가능하게 한다. 아래 그림과 같다.

  ![picture 2](/images/TFRU_17.png)

- 이 기능은 꽤나 획기적이다. 모듈은 재사용성이 좋고, 유지보수하기 쉬우며, 테스트하기 쉬운 Terraform 코드를 작성하기 위한 핵심 요소이다.  
  한 번 쓰기 시작하면 다시 돌아가지 못할 것이다. 실제로 모든 것을 모듈로 만들어나갈 수 있다.

## Module Basics

- Terraform module은 매우 단순한데, 특정 폴더 하위에 있는 Terraform configuration file들의 집합은 모두 module이다.  
  지금까지 작성했던 Terraform code들은 모두 모듈이다. 그리고 `terraform apply`를 할 때 각 폴더에 들어가서 실행했는데,  
  이런 모듈을 _root module_ 이라고 부른다. 모듈이 어떤 효과를 제공하는지 느끼려면 재사용성 가능한 모듈을 만들어봐야 한다.

- 아래 그림처럼 기존에 `stage/services/webserver-cluster` 하위에 있던 모든 파일들을 `modules/services/webserver-cluster`의  
  하위로 이동시켜보자.

  ![picture 3](/images/TFRU_18.png)

- 이제 위에서 생성한 module을 staging 환경에서 사용할 수 있다.  
  모듈을 사용하는 문법은 아래와 같다.

  ```tf
  module "<NAME>" {
    source = "<SOURCE>"
    [CONFIG...]
  }
  ```

  - `<NAME>`: Terraform code에서 해당 모듈을 사용하기 위한 모듈 이름
  - `<SOURCE>`: 모듈 코드가 있는 경로

- 먼저 `stage/services/webserver-cluster` 하위에 아래의 내용을 담은 `main.tf` 파일을 생성해보자.

```tf
provider "aws" {
  region = "us-east-2"
}

module "webserver_cluster" {
  source = "../../../modules/services/webserver-cluster"
}
```

- 이처럼 `prod` 폴더를 상위에 만들고, `prod/services/webserver-cluster` 하위에 `main.tf` 파일을 생성하고,  
  아래와 같이 작성해보자.

```tf
provider "aws" {
  region = "us-east-2"
}

module "webserver_cluster" {
  source = "../../../modules/services/webserver-cluster"
}
```

- 이제 `prod/services/webserver-cluster` 폴더에서 `terraform init`을 수행하면 module 초기화 단계가 추가된 것을 확인할 수 있다.

- 여기서 `terraform apply`를 수행하기 전, 한 가지 문제점이 있다. 바로 `webserver-cluster` module의 모든 값들이  
  하드코딩되어 있다는 것이다. 예를 들어 security group, ALB name 등 말이다. 그렇기에 이 모듈을 동일한 AWS 계정 내에서  
  두 번 이상 사용하면 충돌이 발생할 것이다.

- 위 문제를 해결하기 위해 `webserver-cluster` module이 설정 가능한 input을 받을 수 있도록 수정해보자.

---
